# Laravel Migrations Searcher Skill

## Purpose

This skill helps manage and search through large numbers of Laravel migrations in your project. The index contains detailed analysis of each migration including:
- DDL operations (CREATE/ALTER/DROP tables)
- DML operations (INSERT/UPDATE/DELETE with WHERE conditions)
- Raw SQL statements
- Eloquent operations (Model::create, ->save(), ->delete())
- Operations in loops
- Dependencies between migrations

## Index Structure

The index is automatically generated by the command:
```bash
php artisan migrations:index
```

### Available Index Files:

1. **index-full.md** - Complete chronological list of all migrations with full details
2. **index-by-type.md** - Grouped by migration type (as defined in your config)
3. **index-by-table.md** - Grouped by database tables
4. **index-by-operation.md** - Grouped by operations (CREATE/ALTER/DATA/DROP)
5. **stats.json** - Statistics and metadata

## How Claude Uses This Skill

### 1. Always Read the Index First

**ALWAYS** start by reading the appropriate index file:

```
User: "Find the migration that adds subscription_plan column to users"
Claude: [view .claude/skills/laravel-migration-searcher/index-by-table.md]
        [searches in "users" section]
        [finds relevant migrations]
```

### 2. Ask Clarifying Questions

If the query is unclear, **ASK**:

```
User: "Fix the users migration"
Claude: [ask_user_input_v0]
        - "Which users migration? I found 23 migrations affecting this table"
        - "What kind of problem do you want to fix?"
```

### 3. Use the Right Index

- **Searching by table?** → `index-by-table.md`
- **Searching by migration type?** → `index-by-type.md`
- **Searching for data modifications?** → `index-by-operation.md`
- **Overview of everything?** → `index-full.md`

### 4. Always Provide Context

When you find a migration, **show**:
- Full file path
- Migration type
- What exactly it does
- Related migrations (if any)

## Usage Examples

### Example 1: Finding a Migration

```
User: "Which migration adds legacy_id to the orders table?"

Claude:
1. [view .claude/skills/laravel-migration-searcher/index-by-table.md]
2. Searches "orders" section
3. Finds: database/migrations/2023_05_12_add_legacy_mapping.php
4. Responds with full context
```

### Example 2: Debugging a Problem

```
User: "After running migrations, users have incorrect subscription dates"

Claude:
1. [view .claude/skills/laravel-migration-searcher/index-by-table.md]
2. Checks "users" section
3. Searches for migrations operating on subscription_* columns
4. Identifies migrations with DML operations on those fields
5. Asks: "Does the problem affect all users or only some?"
```

### Example 3: Finding Conflicts

```
User: "I think I have duplicate migrations for the status column"

Claude:
1. [view .claude/skills/laravel-migration-searcher/index-by-operation.md]
2. Searches all ALTER TABLE with 'status' column
3. Identifies potential conflicts
4. Shows list with indication of which might conflict
```

### Example 4: Finding Data Deletion

```
User: "Which migration deletes records from orders where status='cancelled'?"

Claude:
1. [view .claude/skills/laravel-migration-searcher/index-by-operation.md]
2. Checks "Data Modifications (DATA)" section
3. Searches for DELETE on orders table with status condition
4. Responds:

Found migration:

**File:** database/migrations/2023_09_10_cleanup_cancelled_orders.php
**Type:** default

**DML Operations:**
- **DELETE** on `orders`
  - WHERE: status = 'cancelled' AND created_at < '2023-01-01'

**Raw SQL:**
```sql
DELETE FROM orders WHERE status = 'cancelled' AND created_at < '2023-01-01'
```

This migration deletes orders that are cancelled AND created before 2023-01-01.
Is this the migration you're looking for?
```

## Response Formatting

### ✅ GOOD:

```
Found the migration responsible for this issue:

**File:** database/migrations/2024_01_15_add_subscription_plan.php
**Type:** default
**Operations:**
- ALTER TABLE users ADD COLUMN subscription_plan VARCHAR(50)
- ALTER TABLE users ADD INDEX idx_subscription_plan

**Related migrations:**
- 2024_01_10_prepare_subscription_data.php (prepares data)
- 2024_01_20_verify_subscriptions.php (verifies after completion)

Would you like to see the full contents of any of these migrations?
```

### ❌ BAD:

```
There's an add_subscription_plan migration that does this.
```

## Index Updates

The index should be refreshed when:
- A new migration is added
- A migration is deleted
- An existing migration is modified

```bash
php artisan migrations:index --refresh
```

## Rules and Limits

1. **DO NOT** manually edit index files - always use `php artisan migrations:index`
2. **ALWAYS** read the index before answering about migrations
3. **ASK** when something is unclear - better to ask than to guess
4. **CONTEXT** - always provide full context of found migrations
5. **VERIFY** - if unsure, check the index instead of guessing

## Index Entry Structure

Each migration in the index has this format:

```markdown
### 2024_01_15_143022_add_subscription_plan_to_users.php

**Type:** default  
**Path:** database/migrations/2024_01_15_143022_add_subscription_plan_to_users.php  
**Timestamp:** 2024_01_15_143022

**Tables:**
- users (ALTER)

**DDL Operations:**
- addColumn: subscription_plan (string, nullable)
- addColumn: subscription_expires_at (timestamp, nullable)
- addIndex: idx_subscription_plan

**DML Operations:**
- **UPDATE** on `users`
  - WHERE: subscription_plan IS NULL
  - Columns: subscription_plan, subscription_expires_at
  - Data: ['subscription_plan' => 'free', 'subscription_expires_at' => NULL]

**Raw SQL:**
- **[UPDATE]** (statement)
  ```sql
  UPDATE users SET subscription_plan = 'free' WHERE subscription_plan IS NULL
  ```

**Dependencies:**
- Requires: 2024_01_10_create_subscription_plans.php
- Used in: 2024_01_20_verify_subscriptions.php
```

## Advanced Searching

### Multiple Criteria

```
User: "Find all migrations that modify users or orders tables and operate on columns with 'legacy' in the name"

Claude:
1. [view index-by-table.md] → "users" and "orders" sections
2. Filters tables: users, orders
3. Searches for columns containing 'legacy'
4. Returns list prioritized (most likely first)
```

### Dependency Analysis

```
User: "What will be affected if I remove the 2024_01_15_add_subscription_plan migration?"

Claude:
1. [view index-full.md]
2. Finds the migration
3. Checks "Dependencies" → finds dependent migrations
4. Warns about consequences
```

## Debugging Mode

When user reports a problem with migrations:

1. **Identify stage** - where the problem occurs
2. **Find responsible migrations** - which migrations operate on that data
3. **Check order** - are migrations in correct order
4. **Look for conflicts** - do different migrations do conflicting things
5. **Propose fix** - specific migration to repair

## Example Complete Interaction

```
User: "After running migrations, users table has nulls in email_verified_at even though source data had dates"

Claude:
[view .claude/skills/laravel-migration-searcher/index-by-table.md]

Analyzing the problem:

1. Checked migrations for 'users' table - found 34 migrations
2. Problem likely in migrations that modify email_verified_at

[view .claude/skills/laravel-migration-searcher/index-by-operation.md]

Found suspicious migration:

**database/migrations/2023_08_15_prepare_user_verification.php**
- Operation: ALTER TABLE users MODIFY email_verified_at (timestamp, nullable, default NULL)
- This migration resets values to NULL!

Is email_verified_at column named the same in source data?

Clarifying questions:
1. What was the column name in source data?
2. What data type did it have in source?
3. After importing source data but before migrations, are dates present?
```

## Best Practices

1. **Always use index** - never guess where a migration is
2. **Ask for details** - better 2 questions than wrong assumption
3. **Show full context** - path, type, operations, dependencies
4. **Group results** - if you found 10 migrations, group them logically
5. **Warn about dependencies** - always check dependencies before modifications

---

**Version:** 2.0  
**Last Update:** 2025-02-17  
**Author:** Laravel Migration Searcher System
